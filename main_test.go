package main

import (
	"testing"

	"github.com/AustralianCyberSecurityCentre/azul-bedrock/v10/gosrc/plugin"
)

func TestGeneratedBinary(t *testing.T) {
	pr := plugin.NewPluginRunner(&EntropyPlugin{})

	binary := make([]byte, 2216)
	for i := 0; i < 2216; i++ {
		binary[i] = 'a'
	}

	result := pr.RunTest(t, &plugin.RunTestOptions{
		ContentFileBytes:            binary,
		DisableUncartingContentFile: true,
	}, "Single A character binary.")
	result.AssertJobResultEqual(t, &plugin.TestJobResult{
		Status: "completed",
		Events: []plugin.TestJobEvent{
			{
				Features: map[string][]plugin.TestBinaryEntityFeature{
					"entropy": {
						{
							Value: "0",
						},
					},
				},
				Info: "{\"entropy\":{\"overall\":0,\"block_size\":256,\"block_count\":8,\"blocks\":[0,0,0,0,0,0,0,0]}}",
			},
		},
	})
}

func TestSimpleExe(t *testing.T) {
	pr := plugin.NewPluginRunner(&EntropyPlugin{})
	result := pr.RunTest(t, &plugin.RunTestOptions{
		DownloadSha256: "702e31ed1537c279459a255460f12f0f2863f973e121cd9194957f4f3e7b0994",
	}, "Benign Windows 32EXE, python library executable python_mcp.exe")
	result.AssertJobResultEqual(t, &plugin.TestJobResult{
		Status: "completed",
		Events: []plugin.TestJobEvent{
			{
				Features: map[string][]plugin.TestBinaryEntityFeature{
					"entropy": {
						{
							Value: "4.857399039272421",
						},
					},
				},
				Info: "{\"entropy\":{\"overall\":4.857399039272421,\"block_size\":256,\"block_count\":104,\"blocks\":[4.522049934672748,1.6920849444664516,1.26845247090193,0,5.379438362454763,5.325550979383899,5.468231919914441,5.528856527551879,5.76637801340328,5.457535145068916,5.558873896009026,4.873851528739253,0.11055713125913882,0,2.9634036240505144,3.6889140546252595,2.723130280777557,4.620711132690382,5.0027590537533975,4.62537480701318,0.6209561318445891,0,1.8700226414566268,2.234977614805236,2.2414630107761235,3.5711629383637074,2.8978124926010635,2.840903075134075,5.004200952969769,1.3227498714093135,0,0,1.218062158608576,4.663217167300026,4.641185668199277,4.590963900354325,2.643006224255718,1.8499322053070832,0,0,0.2759049089149221,3.63498851991412,0.6182753313693203,0,0.18415065608732903,0.9418313706190309,2.176351628136459,2.74381953001855,3.7677301671164827,4.086196302855346,4.54308767911663,3.9827791822122007,3.4388852756864505,4.719550287046781,4.482973184471822,4.396652839227367,4.6958361285749595,4.446389707259104,4.842348385387817,5.0928915969712225,5.150815286643428,3.8288458156219156,4.775698718545808,5.011005200409649,4.566762369674076,5.074142680105138,4.61640682408728,4.310576260899466,5.069796955876089,4.77955341710354,4.483321000928178,5.0695951468998155,4.707279476397614,4.841534151382498,4.887584845352718,4.7524251079766024,1.8205872763111384,0,1.6521862930400526,1.577722171732527,1.109901014887819,1.8082301427557,3.7315281144702115,4.443234424692658,3.9623014406080426,4.599222155935755,4.2234856007325865,5.007959054497452,5.111850925663273,4.263898159253503,4.986390024978242,4.9625122345383605,4.981861164415283,5.367110877010914,5.045903387071661,1.7258828277269278,2.403189812168571,3.2840422673256837,4.439919841246486,3.9937151139206906,2.921799760524372,4.886839745955689,4.8368218164436625,5.03493912100513]}}",
			},
		},
	})
}

func TestSimpleExeDifferentBufferSize(t *testing.T) {
	// Lower buffer size to 1kb (that was multiple chunks are requested but nothing should change)
	maxBufferSize = uint64(1 * 1024)
	pr := plugin.NewPluginRunner(&EntropyPlugin{})

	result := pr.RunTest(t, &plugin.RunTestOptions{
		DownloadSha256: "702e31ed1537c279459a255460f12f0f2863f973e121cd9194957f4f3e7b0994", // ~27kB
	}, "Benign Windows 32EXE, python library executable python_mcp.exe")
	result.AssertJobResultEqual(t, &plugin.TestJobResult{
		Status: "completed",
		Events: []plugin.TestJobEvent{
			{
				Features: map[string][]plugin.TestBinaryEntityFeature{
					"entropy": {
						{
							Value: "4.857399039272421",
						},
					},
				},
				Info: "{\"entropy\":{\"overall\":4.857399039272421,\"block_size\":256,\"block_count\":104,\"blocks\":[4.522049934672748,1.6920849444664516,1.26845247090193,0,5.379438362454763,5.325550979383899,5.468231919914441,5.528856527551879,5.76637801340328,5.457535145068916,5.558873896009026,4.873851528739253,0.11055713125913882,0,2.9634036240505144,3.6889140546252595,2.723130280777557,4.620711132690382,5.0027590537533975,4.62537480701318,0.6209561318445891,0,1.8700226414566268,2.234977614805236,2.2414630107761235,3.5711629383637074,2.8978124926010635,2.840903075134075,5.004200952969769,1.3227498714093135,0,0,1.218062158608576,4.663217167300026,4.641185668199277,4.590963900354325,2.643006224255718,1.8499322053070832,0,0,0.2759049089149221,3.63498851991412,0.6182753313693203,0,0.18415065608732903,0.9418313706190309,2.176351628136459,2.74381953001855,3.7677301671164827,4.086196302855346,4.54308767911663,3.9827791822122007,3.4388852756864505,4.719550287046781,4.482973184471822,4.396652839227367,4.6958361285749595,4.446389707259104,4.842348385387817,5.0928915969712225,5.150815286643428,3.8288458156219156,4.775698718545808,5.011005200409649,4.566762369674076,5.074142680105138,4.61640682408728,4.310576260899466,5.069796955876089,4.77955341710354,4.483321000928178,5.0695951468998155,4.707279476397614,4.841534151382498,4.887584845352718,4.7524251079766024,1.8205872763111384,0,1.6521862930400526,1.577722171732527,1.109901014887819,1.8082301427557,3.7315281144702115,4.443234424692658,3.9623014406080426,4.599222155935755,4.2234856007325865,5.007959054497452,5.111850925663273,4.263898159253503,4.986390024978242,4.9625122345383605,4.981861164415283,5.367110877010914,5.045903387071661,1.7258828277269278,2.403189812168571,3.2840422673256837,4.439919841246486,3.9937151139206906,2.921799760524372,4.886839745955689,4.8368218164436625,5.03493912100513]}}",
			},
		},
	})
}
